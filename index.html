<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Arrhenius</title>
    <!-- Incluye Tailwind CSS para el estilizado -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define la fuente Inter y estilos generales para el cuerpo */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Contenedor principal de la aplicación */
        .container {
            width: 100%;
            max-width: 900px;
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Encabezado y botones de navegación principal */
        .header {
            background-color: #4a5568;
            padding: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #2d3748;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #a0aec0;
        }
        .nav-buttons {
            display: flex;
            justify-content: center;
            background-color: #2d3748;
            border-bottom: 1px solid #4a5568;
            padding: 0.5rem 0;
        }
        .nav-buttons button {
            flex-grow: 1;
            padding: 1rem 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .nav-buttons button.active {
            background-color: #4a5568;
            color: #ffffff;
            border-bottom: 2px solid #6b7280;
        }
        .nav-buttons button:not(.active):hover {
            background-color: #3b4557;
        }

        /* Estilos del área de contenido principal y scrollbar */
        .content {
            padding: 2rem;
            overflow-y: auto;
            max-height: 70vh;
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        .content::-webkit-scrollbar {
            width: 8px;
        }
        .content::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .content::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 20px;
            border: 2px solid #2d3748;
        }
        /* La clase `active` ahora controla la visibilidad */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }

        /* Estilos para los formularios y entradas de texto */
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #4a5568;
            background-color: #1a202c;
            color: #e2e8f0;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #a0aec0;
        }
        .btn-calc, .btn-gemini, .btn-ask-gemini {
            width: 100%;
            padding: 1rem;
            color: #fff;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
        }
        .btn-calc {
            background-color: #38b2ac;
        }
        .btn-calc:hover {
            background-color: #319795;
            transform: translateY(-2px);
        }
        .btn-gemini {
            background-color: #6a6a6a;
            margin-top: 1rem;
        }
        .btn-gemini:hover {
            background-color: #555555;
            transform: translateY(-2px);
        }
        .btn-ask-gemini {
            background-color: #4c51bf;
        }
        .btn-ask-gemini:hover {
            background-color: #434190;
        }

        /* Estilos para el cuadro de resultados */
        .result-box {
            background-color: #4a5568;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 2rem;
        }
        .result-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #a0aec0;
        }
        .result-box p {
            margin-bottom: 0.5rem;
        }

        /* Estilos de los botones de sub-navegación */
        .sub-nav-buttons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 2rem;
        }
        .sub-nav-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            background-color: #4a5568;
            color: #e2e8f0;
            border: none;
            transition: background-color 0.3s;
        }
        .sub-nav-buttons button.active {
            background-color: #a0aec0;
            color: #2d3748;
        }
        .sub-nav-buttons button:hover:not(.active) {
            background-color: #6b7280;
        }

        /* Estilos mejorados para las tablas de datos */
        .table-container {
            margin-bottom: 2rem;
            overflow-x: auto;
            max-width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: #4a5568;
            border-radius: 0.5rem;
            overflow: hidden; /* Asegura que las esquinas redondeadas se apliquen correctamente */
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #6b7280;
        }
        th {
            background-color: #2d3748;
            font-weight: 700;
            color: #a0aec0;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .table-container h4 {
            color: #a0aec0;
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        /* Estilos mejorados para el glosario */
        .glossary-card {
            background-color: #4a5568;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .glossary-card h4 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #a0aec0;
        }
        .list-item h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #a0aec0;
        }
        .radio-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .radio-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .note {
            background-color: #1f2937;
            border-left: 4px solid #38b2ac;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
        }

        /* Estilos para la nueva sección de preguntas a Gemini */
        .ask-gemini-section {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-top: 2rem;
        }

        .ask-gemini-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #a0aec0;
        }
        
        #gemini-question-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #4a5568;
            background-color: #1a202c;
            color: #e2e8f0;
            transition: border-color 0.3s;
            margin-bottom: 1rem;
        }
        
        #gemini-question-textarea:focus {
            outline: none;
            border-color: #a0aec0;
        }

        #gemini-theory-response-box {
            background-color: #4a5568;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
        }
        
        #gemini-theory-response-box h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #a0aec0;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container">
        <!-- Encabezado de la aplicación -->
        <div class="header">
            <h1>Calculadora de la Ley de Arrhenius</h1>
        </div>

        <!-- Botones de navegación principal -->
        <div class="nav-buttons">
            <button id="btn-calculos" class="active">Cálculos</button>
            <button id="btn-teoria">Teoría y Datos</button>
            <button id="btn-manual">Manual de Uso</button>
        </div>
        
        <!-- Sección de Cálculos -->
        <div id="calculos-section" class="section active content">
            <h2 class="text-2xl font-bold mb-6 text-center">Cálculos de Vacancias y Espacios Intersticiales</h2>
            
            <form id="arrhenius-form">
                
                <!-- Input para N(t) -->
                <div class="form-group">
                    <label for="Nt-val">
                        N(t) (Concentración)
                        <span id="Nt-unidad-label" class="text-sm font-normal">(deja vacío para incógnita)</span>
                    </label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="Nt-val" placeholder="Valor numérico">
                        <select id="Nt-unit" class="w-1/2">
                            <option value="vacancies">Densidad de Vacancias</option>
                            <option value="interstitials">Densidad de Espacios Intersticiales</option>
                        </select>
                    </div>
                </div>

                <!-- Input para N0, con opción de cálculo -->
                <div class="form-group">
                    <label for="N0-val">N₀ (Factor preexponencial)</label>
                    <div class="radio-options">
                        <label>
                            <input type="radio" name="N0-method" value="direct" id="N0-direct" checked>
                            Número Directo (átomos/m³)
                        </label>
                        <label>
                            <input type="radio" name="N0-method" value="calculated" id="N0-calculated">
                            Calcular a partir de Parámetro de Red
                        </label>
                    </div>
                    <div id="N0-direct-input">
                        <input type="text" id="N0-val" placeholder="ej: 3e22">
                    </div>
                    <div id="N0-calculated-input" class="hidden">
                        <div class="form-group">
                            <label for="n_atoms">Número de Espacios Válidos para Defectos Puntuales</label>
                            <input type="text" id="n_atoms" placeholder="ej: 2 para BCC, 4 para FCC, 6 para HCP">
                        </div>
                        <div class="form-group">
                            <label for="lattice-param">Parámetro de Red (nm)</label>
                            <input type="text" id="lattice-param" placeholder="ej: 0.2866">
                        </div>
                    </div>
                </div>

                <!-- Input para Q -->
                <div class="form-group">
                    <label for="Q-val">Q (Energía de Activación)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="Q-val" placeholder="Valor numérico">
                        <select id="Q-unit" class="w-1/2">
                            <option value="J/atom">J/átomo</option>
                            <option value="eV/atom">eV/átomo</option>
                            <option value="J/mol">J/mol</option>
                            <option value="cal/mol">cal/mol</option>
                        </select>
                    </div>
                </div>

                <!-- Display de la constante k o R -->
                <div class="form-group">
                    <label for="k-const-display">K (Constante)</label>
                    <input type="text" id="k-const-display" value="Selecciona la unidad de Q" readonly class="text-gray-400 bg-gray-700">
                </div>

                <!-- Input para la Temperatura T -->
                <div class="form-group">
                    <label for="T-val">T (Temperatura)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="T-val" placeholder="Valor numérico">
                        <select id="T-unit" class="w-1/2">
                            <option value="K">Kelvin (K)</option>
                            <option value="C">Grados Centígrados (°C)</option>
                            <option value="F">Grados Fahrenheit (°F)</option>
                        </select>
                    </div>
                </div>

                <button type="button" id="calculate-btn" class="btn-calc">Calcular</button>
            </form>

            <!-- Cuadro para mostrar los resultados -->
            <div id="results" class="result-box hidden">
                <h3 class="text-xl font-bold">Resultados</h3>
                <div id="results-content"></div>
                <!-- Nuevo botón para el análisis con Gemini -->
                <button type="button" id="gemini-analysis-btn" class="btn-gemini mt-4 hidden">
                    Análisis de Resultados ✨
                </button>
                <!-- Sección para el análisis generado por la IA -->
                <div id="gemini-analysis-box" class="mt-4 p-4 bg-gray-600 rounded-md hidden">
                    <h4 class="font-semibold mb-2">Análisis de la IA:</h4>
                    <p id="gemini-analysis-text">Cargando análisis...</p>
                </div>
            </div>
        </div>
        
        <!-- Sección de Teoría y Datos -->
        <div id="teoria-section" class="section content">
            <h2 class="text-2xl font-bold mb-6 text-center">Teoría y Datos</h2>
            
            <!-- Contenido de la sub-sección Teoría -->
            <div id="teoria-sub-section">
                <h3 class="text-xl font-semibold mb-4 text-cyan-400">Ley de Arrhenius en Metalurgia</h3>
                <p class="mb-4">La Ley de Arrhenius es fundamental en la ciencia de materiales, ya que nos ayuda a predecir cómo la temperatura afecta la velocidad de procesos atómicos, como la **difusión** y la formación de **vacancias** en un material sólido. En pocas palabras, nos dice que si calientas un metal, sus átomos se moverán más rápido y los procesos internos se acelerarán.</p>
                <p class="mb-4">La forma de la ecuación que describe esto es: N(t) = N₀ e^(-Q / kT)</p>
                <p class="mb-4 font-semibold text-cyan-400">Componentes de la Ecuación:</p>
                <div class="list-item">
                    <h4>N(t):</h4>
                    <p>La concentración de defectos (como vacancias o intersticios) en un momento dado. A medida que sube la temperatura, este valor aumenta, ya que hay más energía para crear estos defectos.</p>
                </div>
                <div class="list-item">
                    <h4>N₀:</h4>
                    <p>El número total de sitios disponibles para que los defectos se formen. Por ejemplo, en el caso de las vacancias, es el número total de átomos en el material.</p>
                </div>
                <div class="list-item">
                    <h4>Q:</h4>
                    <p>La energía de activación. Es la "barrera energética" que debe superarse para que un átomo se mueva o para que se forme un defecto. Un Q alto significa que el proceso es más difícil de iniciar.</p>
                </div>
                <div class="list-item">
                    <h4>k:</h4>
                    <p>La constante de Boltzmann (1.38 x 10^-23 J/K), que convierte la temperatura en una medida de energía a nivel individual de las partículas.</p>
                </div>
                <div class="list-item">
                    <h4>T:</h4>
                    <p>La temperatura absoluta, siempre en Kelvin.</p>
                </div>
                
                <h3 class="text-xl font-semibold mt-8 mb-4 text-cyan-400">Datos y Constantes</h3>
                <p class="mb-4">Para utilizar la ecuación de Arrhenius, es crucial elegir la constante correcta (k o R) según las unidades de energía de activación (Q).</p>
                <p class="mb-4">La **constante de Boltzmann (kB)** se utiliza cuando Q se mide en unidades por átomo, como **J/átomo** (1.38 x 10^-23 J/K) o **eV/átomo** (8.62 x 10^-5 eV/K). Por otro lado, la **constante de los Gases Ideales (R)** se usa para unidades molares, como **J/mol** (8.314 J/(mol·K)) o **cal/mol** (1.987 cal/(mol·K)).</p>
                
                <p class="mb-4">Las propiedades de los metales también son importantes. La estructura cristalina, como la **Cúbica Centrada en el Cuerpo (BCC)** o la **Cúbica Centrada en las Caras (FCC)**, determina el número de átomos por celda unitaria (por ejemplo, 2 para BCC y 4 para FCC), un dato clave para calcular N₀. Además, el **parámetro de red**, que es la longitud de los lados de la celda unitaria, varía entre metales: el hierro (Fe) tiene una estructura BCC con un parámetro de 0.2866 nm, mientras que el cobre (Cu) y el aluminio (Al) tienen una estructura FCC con parámetros de 0.3615 nm y 0.4049 nm, respectivamente.</p>

                <h3 class="text-xl font-semibold mt-8 mb-4 text-cyan-400">Glosario de Términos</h3>
                
                <div class="glossary-card">
                    <h4>Estructuras Cristalinas</h4>
                    <p>Se refieren a la forma ordenada en que los átomos se acomodan en un material sólido. Esta disposición, como la BCC o FCC, define muchas de las propiedades físicas y mecánicas del material.</p>
                </div>
                
                <div class="glossary-card">
                    <h4>Parámetro de Red</h4>
                    <p>Es la medida de la celda unitaria de un cristal, la cual es la unidad más pequeña que se repite para construir toda la red. Piensa en ello como la "longitud del lado" de la unidad básica del material.</p>
                </div>
                
                <div class="glossary-card">
                    <h4>Defectos Puntuales</h4>
                    <p>Son imperfecciones o irregularidades a nivel atómico dentro de una red cristalina. A pesar de su nombre, son cruciales para el comportamiento del material, ya que permiten la difusión y el movimiento de los átomos.</p>
                    <ul class="list-disc ml-6 mt-2">
                        <li><strong>Vacancia:</strong> Es un lugar en la red cristalina donde falta un átomo.</li>
                        <li><strong>Átomo Intersticial:</strong> Un átomo adicional que se ha metido en un espacio vacío (intersticio) que normalmente no está ocupado.</li>
                    </ul>
                </div>
                
                <div class="glossary-card">
                    <h4>Energía de Activación (Q)</h4>
                    <p>Es la cantidad mínima de energía que se necesita para que ocurra un proceso. En metalurgia, es la energía requerida para que un átomo salte de un sitio a otro en el material. Es el "empujón" energético necesario para iniciar una acción.</p>
                </div>
            </div>

            <!-- Nueva sección para preguntas a Gemini sobre teoría -->
            <div class="ask-gemini-section">
                <h3 class="text-center">Pregúntale a Gemini sobre la teoría 🧠</h3>
                <textarea id="gemini-question-textarea" placeholder="Escribe tu pregunta aquí sobre la teoría de Arrhenius o la ciencia de materiales..."></textarea>
                <button type="button" id="ask-gemini-btn" class="btn-ask-gemini">
                    Preguntar a Gemini
                </button>
            </div>
            
            <!-- Cuadro para mostrar la respuesta de Gemini -->
            <div id="gemini-theory-response-box" class="result-box hidden">
                <h4 class="font-semibold mb-2">Respuesta de la IA:</h4>
                <p id="gemini-theory-response-text">Cargando respuesta...</p>
            </div>
        </div>

        <!-- Sección de Manual de Uso -->
        <div id="manual-section" class="section content">
            <h2 class="text-2xl font-bold mb-6 text-center">Manual de Instrucciones de Uso</h2>
            
            <div class="list-item">
                <h4 class="font-bold">1. Apartado de cálculos:</h4>
                <ul class="list-disc ml-6">
                    <li>Solamente se deberá dejar un espacio en blanco, el cual para el programa significa que es la incógnita.</li>
                    <li>Si la incógnita tiene más de un tipo de unidad, entonces el programa te dará las respuestas con cada una de las unidades disponibles.</li>
                    <li>En el ingreso de datos no están permitidas las comas “,”, para colocar un número con decimales se deberá colocar el punto “.”.</li>
                    <li>En el ingreso de datos el ingreso de números con notación científica se deberá realizar de la manera: `e#`. Por ejemplo: `3e22` = 3 x 10^22; `3e-34` = 3 x 10^-34. De lo contrario el programa no podrá operar.</li>
                    <li>Cuando se quiera calcular N₀ con parámetro de red y espacios válidos para defectos puntuales, solo se podrá hacer si lo estamos calculando para estructuras cristalinas <strong>FCC</strong> y <strong>BCC</strong>.</li>
                    <li>El parámetro de red y el número de espacios válidos para defectos puntuales no pueden ser incógnitas; solo pueden ser valores de entrada para el cálculo de N0. Sin embargo, N0 sí puede ser la incógnita principal si los demás valores (N(t), Q y T) están presentes.</li>
                </ul>
                <div class="note">
                    <p><strong>Nota:</strong> Es importante tener conocimientos previos para poder interpretar los resultados dados.</p>
                </div>
            </div>
            
            <div class="list-item">
                <h4 class="font-bold">2. Apartado de Teoría y datos:</h4>
                <ul class="list-disc ml-6">
                    <li>En este apartado podrás encontrar teoría que relaciona la ley de Arrhenius con la ingeniería metalúrgica. Este contenido es limitado, pero te puede ayudar.</li>
                    <li>En la sección de datos encontrarás datos que te pueden ayudar con los cálculos.</li>
                </ul>
            </div>
            
            <p class="text-center mt-8 font-semibold">¡Disfruta la aplicación y saca el mayor provecho!</p>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sections = {
                'calculos-section': document.getElementById('calculos-section'),
                'teoria-section': document.getElementById('teoria-section'),
                'manual-section': document.getElementById('manual-section')
            };
            const navButtons = {
                'btn-calculos': document.getElementById('btn-calculos'),
                'btn-teoria': document.getElementById('btn-teoria'),
                'btn-manual': document.getElementById('btn-manual')
            };

            const form = document.getElementById('arrhenius-form');
            const calculateBtn = document.getElementById('calculate-btn');
            const resultsBox = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            const geminiAnalysisBtn = document.getElementById('gemini-analysis-btn');
            const geminiAnalysisBox = document.getElementById('gemini-analysis-box');
            const geminiAnalysisText = document.getElementById('gemini-analysis-text');

            // Nuevos elementos para la sección de teoría
            const askGeminiBtn = document.getElementById('ask-gemini-btn');
            const geminiQuestionTextarea = document.getElementById('gemini-question-textarea');
            const geminiTheoryResponseBox = document.getElementById('gemini-theory-response-box');
            const geminiTheoryResponseText = document.getElementById('gemini-theory-response-text');
            
            const N0MethodDirect = document.getElementById('N0-direct');
            const N0MethodCalculated = document.getElementById('N0-calculated');
            const N0DirectInput = document.getElementById('N0-direct-input');
            const N0CalculatedInput = document.getElementById('N0-calculated-input');
            const QUnitSelect = document.getElementById('Q-unit');
            const KConstDisplay = document.getElementById('k-const-display');

            // Constantes para la ecuación de Arrhenius
            const CONSTANTS = {
                'J/atom': { val: 1.380649e-23, unit: 'J/K', name: 'Boltzmann (k)' },
                'eV/atom': { val: 8.617333262e-5, unit: 'eV/K', name: 'Boltzmann (k)' },
                'J/mol': { val: 8.314462618, unit: 'J/(mol·K)', name: 'Gases Ideales (R)' },
                'cal/mol': { val: 1.987204259, unit: 'cal/(mol·K)', name: 'Gases Ideales (R)' }
            };

            // Mapeo de estructuras cristalinas para átomos/celda
            const LATTICE_ATOMS = {
                'BCC': 2,
                'FCC': 4
            };

            // Función para cambiar entre secciones principales
            function switchSection(sectionId) {
                Object.values(sections).forEach(sec => sec.classList.remove('active'));
                sections[sectionId].classList.add('active');
                
                Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
                navButtons[`btn-${sectionId.replace('-section', '')}`].classList.add('active');
            }
            
            // Eventos de navegación principal
            Object.keys(navButtons).forEach(id => {
                navButtons[id].addEventListener('click', () => switchSection(id.replace('btn-', '') + '-section'));
            });
            
            // Configuración de vista inicial
            switchSection('calculos-section');
            
            // Lógica para mostrar/ocultar los campos de entrada de N0
            N0MethodDirect.addEventListener('change', () => {
                N0DirectInput.classList.remove('hidden');
                N0CalculatedInput.classList.add('hidden');
            });

            N0MethodCalculated.addEventListener('change', () => {
                N0DirectInput.classList.add('hidden');
                N0CalculatedInput.classList.remove('hidden');
            });

            // Actualiza la constante 'k' según la unidad de 'Q'
            QUnitSelect.addEventListener('change', () => {
                const selectedUnit = QUnitSelect.value;
                const constant = CONSTANTS[selectedUnit];
                KConstDisplay.value = `${constant.val.toPrecision(7)} ${constant.unit}`;
            });
            QUnitSelect.dispatchEvent(new Event('change'));

            // Función para parsear notación científica y comas
            function parseInput(val) {
                if (!val) return null;
                return parseFloat(val.replace(/,/g, '.').replace(/([0-9])e([+-]?[0-9]+)/, '$1e$2'));
            }

            // Función para formatear número a 5 cifras significativas
            function formatNumber(num) {
                if (num === 0) return '0.0000';
                return num.toExponential(4); // 4 decimales para 5 cifras significativas
            }

            // Función para llamar a la API de Gemini para el análisis de cálculos
            async function getGeminiAnalysis(result, inputData, unknown) {
                geminiAnalysisBox.classList.remove('hidden');
                geminiAnalysisText.textContent = 'Generando análisis...';
                geminiAnalysisText.classList.remove('text-red-400');
                
                const prompt = `
                    Eres un experto en metalurgia y ciencia de materiales. Proporciona un análisis breve, simple y claro del siguiente resultado de cálculo de Arrhenius en español, sin utilizar jerga técnica de la academia.
                    
                    El cálculo fue:
                    - Incógnita: ${unknown}
                    - Resultado: ${result}
                    - Datos de entrada:
                        - N(t) (Concentración): ${inputData.Nt_val}
                        - N0 (Factor preexponencial): ${inputData.N0_val}
                        - Q (Energía de Activación): ${inputData.Q_val} ${inputData.Q_unit}
                        - T (Temperatura): ${inputData.T_val} ${inputData.T_unit}

                    Explica el significado físico del resultado calculado en un tono conversacional, amigable y no académico, relacionándolo con procesos metalúrgicos del mundo real como la difusión, la transformación de fase o el tratamiento térmico. Mantén la respuesta en 2-3 párrafos cortos y evita repetir los valores de entrada. Concéntrate en la interpretación del resultado en sí.
                `;

                // Lógica para la llamada a la API de Gemini
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let response = null;
                let retryCount = 0;
                const maxRetries = 5;
                const initialDelay = 1000; // 1 segundo

                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            // Demasiadas solicitudes, implementa retroceso exponencial
                            const delay = initialDelay * Math.pow(2, retryCount);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`Fallo de la llamada a la API con estado: ${response.status}`);
                        }

                        const result = await response.json();
                        const text = result.candidates[0].content.parts[0].text;
                        geminiAnalysisText.textContent = text;
                        return;

                    } catch (error) {
                        console.error('Error al llamar a la API de Gemini:', error);
                        geminiAnalysisText.textContent = 'Hubo un error al generar el análisis. Por favor, inténtalo de nuevo.';
                        geminiAnalysisText.classList.add('text-red-400');
                        return;
                    }
                }
                
                geminiAnalysisText.textContent = 'No se pudo conectar a la API después de varios intentos.';
                geminiAnalysisText.classList.add('text-red-400');
            }

            // Función para llamar a la API de Gemini para preguntas de teoría
            async function getGeminiTheoryResponse(question) {
                geminiTheoryResponseBox.classList.remove('hidden');
                geminiTheoryResponseText.textContent = 'Generando respuesta...';
                geminiTheoryResponseText.classList.remove('text-red-400');

                const prompt = `
                    Actúa como un profesor de ciencias de materiales y metalurgia. Responde la siguiente pregunta de un estudiante de una manera clara, concisa y fácil de entender. Usa un tono amigable y educativo. Si la pregunta no está relacionada con la ciencia de materiales, explica que tu conocimiento es limitado a ese campo. La pregunta es: "${question}"
                `;

                // Lógica para la llamada a la API de Gemini
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let response = null;
                let retryCount = 0;
                const maxRetries = 5;
                const initialDelay = 1000;

                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            const delay = initialDelay * Math.pow(2, retryCount);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`Fallo de la llamada a la API con estado: ${response.status}`);
                        }

                        const result = await response.json();
                        const text = result.candidates[0].content.parts[0].text;
                        geminiTheoryResponseText.textContent = text;
                        return;

                    } catch (error) {
                        console.error('Error al llamar a la API de Gemini:', error);
                        geminiTheoryResponseText.textContent = 'Hubo un error al generar la respuesta. Por favor, inténtalo de nuevo.';
                        geminiTheoryResponseText.classList.add('text-red-400');
                        return;
                    }
                }
                
                geminiTheoryResponseText.textContent = 'No se pudo conectar a la API después de varios intentos.';
                geminiTheoryResponseText.classList.add('text-red-400');
            }

            // Lógica principal de cálculo
            calculateBtn.addEventListener('click', async () => {
                resultsContent.innerHTML = '';
                resultsBox.classList.add('hidden');
                geminiAnalysisBtn.classList.add('hidden');
                geminiAnalysisBox.classList.add('hidden');
                
                const Nt_val = parseInput(document.getElementById('Nt-val').value);
                const Q_val = parseInput(document.getElementById('Q-val').value);
                const T_val = parseInput(document.getElementById('T-val').value);
                
                let N0_val = null;
                const N0Method = document.querySelector('input[name="N0-method"]:checked').value;
                
                if (N0Method === 'direct') {
                    N0_val = parseInput(document.getElementById('N0-val').value);
                } else if (N0Method === 'calculated') {
                    // Obtiene los valores para el cálculo de N0
                    const n_atoms_input = document.getElementById('n_atoms').value;
                    const lattice_param_input = document.getElementById('lattice-param').value;
                    
                    if (!n_atoms_input || !lattice_param_input) {
                        resultsContent.innerHTML = '<p class="text-red-400">Error: Completa los campos para calcular N₀.</p>';
                        resultsBox.classList.remove('hidden');
                        return;
                    }
                    
                    const n_atoms = parseInput(n_atoms_input);
                    const lattice_param_m = parseInput(lattice_param_input) * 1e-9;
                    
                    const volume_m3 = Math.pow(lattice_param_m, 3);
                    N0_val = n_atoms / volume_m3;
                }
                
                const T_unit = document.getElementById('T-unit').value;
                const Q_unit = document.getElementById('Q-unit').value;
                const Nt_unit = document.getElementById('Nt-unit').value;
                const k_val = CONSTANTS[Q_unit].val;

                const values = { Nt: Nt_val, N0: N0_val, Q: Q_val, T: T_val };
                const unknowns = Object.keys(values).filter(key => values[key] === null);
                
                if (unknowns.length !== 1) {
                    resultsContent.innerHTML = '<p class="text-red-400">Error: Debes dejar exactamente una variable vacía para calcular la incógnita.</p>';
                    resultsBox.classList.remove('hidden');
                    return;
                }
                
                const unknown = unknowns[0];
                let calculatedResult = null;
                let T_K = null;

                // Convierte la temperatura a Kelvin para el cálculo
                if (T_val !== null) {
                    switch (T_unit) {
                        case 'K': T_K = T_val; break;
                        case 'C': T_K = T_val + 273.15; break;
                        case 'F': T_K = (T_val - 32) * (5/9) + 273.15; break;
                    }
                }

                if (unknown === 'Nt') {
                    if (N0_val === null || Q_val === null || T_K === null) return;
                    calculatedResult = N0_val * Math.exp(-Q_val / (k_val * T_K));
                    resultsContent.innerHTML = `
                        <p class="mb-2"><strong>La incógnita es N(t)</strong></p>
                        <p>Resultado: ${formatNumber(calculatedResult)} ${Nt_unit === 'vacancies' ? 'Vacancias/m³' : 'Espacios Intersticiales/m³'}</p>
                    `;
                } else if (unknown === 'N0') {
                    if (Nt_val === null || Q_val === null || T_K === null) return;
                    calculatedResult = Nt_val / Math.exp(-Q_val / (k_val * T_K));
                    resultsContent.innerHTML = `
                        <p class="mb-2"><strong>La incógnita es N₀</strong></p>
                        <p>Resultado: ${formatNumber(calculatedResult)} átomos/m³</p>
                    `;
                } else if (unknown === 'Q') {
                    if (Nt_val === null || N0_val === null || T_K === null) return;
                    if (N0_val === 0 || Nt_val === 0) {
                        resultsContent.innerHTML = '<p class="text-red-400">Error: El valor de N₀ o N(t) no puede ser cero para este cálculo.</p>';
                        resultsBox.classList.remove('hidden');
                        return;
                    }
                    calculatedResult = -(k_val * T_K) * Math.log(Nt_val / N0_val);
                    resultsContent.innerHTML = `
                        <p class="mb-2"><strong>La incógnita es Q</strong></p>
                        <p>Resultado en ${Q_unit}: ${formatNumber(calculatedResult)}</p>
                    `;
                } else if (unknown === 'T') {
                    if (Nt_val === null || N0_val === null || Q_val === null) return;
                    if (N0_val === 0 || Nt_val === 0 || Nt_val > N0_val) {
                         resultsContent.innerHTML = '<p class="text-red-400">Error: Valores no válidos para el cálculo de T. Asegúrate de que N(t) no sea mayor que N₀ y que ambos no sean cero.</p>';
                         resultsBox.classList.remove('hidden');
                         return;
                    }
                    calculatedResult = -Q_val / (k_val * Math.log(Nt_val / N0_val));
                    const T_Celsius = calculatedResult - 273.15;
                    const T_Fahrenheit = (calculatedResult - 273.15) * 9/5 + 32;
                    resultsContent.innerHTML = `
                        <p class="mb-2"><strong>La incógnita es T</strong></p>
                        <p>Resultado en Kelvin (K): ${formatNumber(calculatedResult)}</p>
                        <p>Resultado en Grados Centígrados (°C): ${formatNumber(T_Celsius)}</p>
                        <p>Resultado en Grados Fahrenheit (°F): ${formatNumber(T_Fahrenheit)}</p>
                    `;
                }

                resultsBox.classList.remove('hidden');
                geminiAnalysisBtn.classList.remove('hidden');

                // Almacena los datos del cálculo para el análisis de Gemini
                geminiAnalysisBtn.dataset.result = JSON.stringify(calculatedResult);
                geminiAnalysisBtn.dataset.unknown = unknown;
                geminiAnalysisBtn.dataset.inputData = JSON.stringify({
                    Nt_val, N0_val, Q_val, T_val, Q_unit, T_unit
                });
            });

            // Escuchador de eventos para el botón de análisis de Gemini
            geminiAnalysisBtn.addEventListener('click', async () => {
                const unknown = geminiAnalysisBtn.dataset.unknown;
                const result = JSON.parse(geminiAnalysisBtn.dataset.result);
                const inputData = JSON.parse(geminiAnalysisBtn.dataset.inputData);
                await getGeminiAnalysis(result, inputData, unknown);
            });

            // Escuchador de eventos para el nuevo botón de preguntas de teoría
            askGeminiBtn.addEventListener('click', async () => {
                const question = geminiQuestionTextarea.value.trim();
                if (question) {
                    await getGeminiTheoryResponse(question);
                }
            });
        });
    </script>
</body>
</html>
